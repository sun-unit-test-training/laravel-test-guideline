
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://sun-unit-test-training.github.io/php-testing-guideline/laravel/03-controller/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.0.6">
    
    
      
        <title>Controller - PHP Testing Guidelines</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2c0c5eaf.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.7fa14f5b.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#controller" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="PHP Testing Guidelines" class="md-header__button md-logo" aria-label="PHP Testing Guidelines" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PHP Testing Guidelines
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Controller
            
          </span>
        </div>
      </div>
    </div>
    <div class="md-header__options">
      
    </div>
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/sun-unit-test-training/php-testing-guideline" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="PHP Testing Guidelines" class="md-nav__button md-logo" aria-label="PHP Testing Guidelines" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    PHP Testing Guidelines
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/sun-unit-test-training/php-testing-guideline" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Giới thiệu
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../01-why/" class="md-nav__link">
        Viết test để làm gì?
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../02-testcase/" class="md-nav__link">
        Cơ bản về test case
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../03-phpunit/" class="md-nav__link">
        PHPUnit
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../04-code-coverage/" class="md-nav__link">
        Code Coverage
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../05-test-doubles-and-di/" class="md-nav__link">
        Test Doubles và DI
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../06-checklist/" class="md-nav__link">
        Checklist
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" checked>
      
      <label class="md-nav__link" for="__nav_8">
        Laravel
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Laravel" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Laravel
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../01-convention/" class="md-nav__link">
        Convention
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../02-mocking/" class="md-nav__link">
        Mocking
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Controller
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Controller
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#intro" class="md-nav__link">
    Intro
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unit-test" class="md-nav__link">
    Unit Test
  </a>
  
    <nav class="md-nav" aria-label="Unit Test">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-first-way" class="md-nav__link">
    The first way
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-second-approach" class="md-nav__link">
    The second approach
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-test" class="md-nav__link">
    Integration Test
  </a>
  
    <nav class="md-nav" aria-label="Integration Test">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#database-rule" class="md-nav__link">
    Database rule
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-upload" class="md-nav__link">
    File upload
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kết-luận" class="md-nav__link">
    Kết luận
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../04-model/" class="md-nav__link">
        Model
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../05-repository-service/" class="md-nav__link">
        Repository / Service
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../06-middleware/" class="md-nav__link">
        Middleware
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../07-mail/" class="md-nav__link">
        Mail
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../08-command/" class="md-nav__link">
        Command
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../09-queue/" class="md-nav__link">
        Queue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../10-others/" class="md-nav__link">
        Others
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      <label class="md-nav__link" for="__nav_9">
        Read more
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Read more" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Read more
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../read-more/mockery/" class="md-nav__link">
        Mockery
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../read-more/mutation-testing/" class="md-nav__link">
        Mutation Testing
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../read-more/references/" class="md-nav__link">
        Tài liệu khác
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../read-more/tdd/" class="md-nav__link">
        TDD
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#intro" class="md-nav__link">
    Intro
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unit-test" class="md-nav__link">
    Unit Test
  </a>
  
    <nav class="md-nav" aria-label="Unit Test">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-first-way" class="md-nav__link">
    The first way
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-second-approach" class="md-nav__link">
    The second approach
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-test" class="md-nav__link">
    Integration Test
  </a>
  
    <nav class="md-nav" aria-label="Integration Test">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#database-rule" class="md-nav__link">
    Database rule
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-upload" class="md-nav__link">
    File upload
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kết-luận" class="md-nav__link">
    Kết luận
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="controller">Controller<a class="headerlink" href="#controller" title="Permanent link">&para;</a></h1>
<h2 id="intro">Intro<a class="headerlink" href="#intro" title="Permanent link">&para;</a></h2>
<p>Giả sử bạn có form request như thế này, bạn sẽ test nó như thế nào?</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code><span style="color: #2838b0">class</span> <span style="color: #287088">ProductCreateRequest</span> <span style="color: #2838b0">extends</span> FormRequest
<span style="color: #888888">{</span>
    <span style="color: #2838b0">public</span> <span style="color: #2838b0">function</span> <span style="color: #785840">rules</span><span style="color: #888888">()</span>
    <span style="color: #888888">{</span>
        <span style="color: #2838b0">return</span> <span style="color: #888888">[</span>
            <span style="color: #b83838">&#39;name&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;required&#39;</span><span style="color: #888888">,</span> <span style="color: #b83838">&#39;max:255&#39;</span><span style="color: #888888">],</span>
            <span style="color: #b83838">&#39;sku&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;required&#39;</span><span style="color: #888888">,</span> Rule<span style="color: #666666">::</span><span style="color: #388038">unique</span><span style="color: #888888">(</span>Product<span style="color: #666666">::</span><span style="color: #388038">getTableName</span><span style="color: #888888">(),</span> <span style="color: #b83838">&#39;sku&#39;</span><span style="color: #888888">)],</span>
            <span style="color: #b83838">&#39;image&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;nullable&#39;</span><span style="color: #888888">,</span> <span style="color: #b83838">&#39;mimes:jpg,png&#39;</span><span style="color: #888888">],</span>
            <span style="color: #b83838">&#39;quantity&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;required&#39;</span><span style="color: #888888">,</span> <span style="color: #b83838">&#39;integer&#39;</span><span style="color: #888888">,</span> <span style="color: #b83838">&#39;min:1&#39;</span><span style="color: #888888">],</span>
            <span style="color: #b83838">&#39;description&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;required&#39;</span><span style="color: #888888">],</span>
            <span style="color: #b83838">&#39;short_description&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;nullable&#39;</span><span style="color: #888888">,</span> <span style="color: #b83838">&#39;max:255&#39;</span><span style="color: #888888">],</span>
        <span style="color: #888888">];</span>
    <span style="color: #888888">}</span>
<span style="color: #888888">}</span>
</code></pre></div>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code><span style="color: #2838b0">class</span> <span style="color: #287088">ProductController</span> <span style="color: #2838b0">extends</span> Controller
<span style="color: #888888">{</span>
    <span style="color: #2838b0">public</span> <span style="color: #2838b0">function</span> <span style="color: #785840">store</span><span style="color: #888888">(</span>ProductCreateRequest <span style="color: #b04040">$request</span><span style="color: #888888">)</span>
    <span style="color: #888888">{</span>
        <span style="color: #b04040">$inputs</span> <span style="color: #666666">=</span> <span style="color: #b04040">$request</span><span style="color: #666666">-&gt;</span><span style="color: #388038">validated</span><span style="color: #888888">();</span>

        <span style="color: #b04040">$product</span> <span style="color: #666666">=</span> <span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">productService</span><span style="color: #666666">-&gt;</span><span style="color: #388038">create</span><span style="color: #888888">(</span><span style="color: #b04040">$inputs</span><span style="color: #888888">);</span>

        <span style="color: #2838b0">return</span> back<span style="color: #888888">()</span><span style="color: #666666">-&gt;</span><span style="color: #388038">with</span><span style="color: #888888">(</span><span style="color: #b83838">&#39;product&#39;</span><span style="color: #888888">,</span> <span style="color: #b04040">$product</span><span style="color: #888888">);</span>
    <span style="color: #888888">}</span>
<span style="color: #888888">}</span>
</code></pre></div>
<p>Nhắc lại một chút về Form Request:</p>
<ul>
<li>Nhiệm vụ chính của class là dùng để khai báo validation rules cho form</li>
<li>Có thể kèm theo việc check authorization</li>
<li>(*1) Có thể kèm theo <a href="https://laravel.com/docs/8.x/validation#adding-after-hooks-to-form-requests">"after" validation hook</a></li>
<li>(*2) Có thể kèm theo <a href="https://laravel.com/docs/8.x/validation#preparing-input-for-validation"><code>prepareForValidation</code></a></li>
<li>Không dùng độc lập mà chỉ inject vào controller (type-hint biến <code>$request</code>)</li>
<li>Laravel service container khi thực hiện controller action sẽ tự động <em>resolve</em> Form Request dựa vào type hint và tự động thực hiện validate với các rules đã khai báo trong Form Request</li>
</ul>
<p>Form Request có thể được test thông qua Unit Test hoặc Integration Test (Laravel thường gọi là Feature Test).</p>
<h2 id="unit-test">Unit Test<a class="headerlink" href="#unit-test" title="Permanent link">&para;</a></h2>
<h3 id="the-first-way">The first way<a class="headerlink" href="#the-first-way" title="Permanent link">&para;</a></h3>
<p>Cách tiếp cận đầu tiên đó là test để kiểm tra tất cả rules cần thiết đã được định nghĩa trong Form Request:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code><span style="color: #2838b0">function</span> <span style="color: #785840">test_it_should_contain_all_the_expected_validation_rules</span><span style="color: #888888">()</span>
<span style="color: #888888">{</span>
    <span style="color: #b04040">$request</span> <span style="color: #666666">=</span> <span style="color: #2838b0">new</span> ProductCreateRequest<span style="color: #888888">();</span>

    <span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">assertEquals</span><span style="color: #888888">([</span>
        <span style="color: #b83838">&#39;name&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;required&#39;</span><span style="color: #888888">,</span> <span style="color: #b83838">&#39;max:255&#39;</span><span style="color: #888888">],</span>
        <span style="color: #b83838">&#39;sku&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;required&#39;</span><span style="color: #888888">,</span> Rule<span style="color: #666666">::</span><span style="color: #388038">unique</span><span style="color: #888888">(</span>Product<span style="color: #666666">::</span><span style="color: #388038">getTableName</span><span style="color: #888888">(),</span> <span style="color: #b83838">&#39;sku&#39;</span><span style="color: #888888">)],</span>
        <span style="color: #b83838">&#39;image&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;nullable&#39;</span><span style="color: #888888">,</span> <span style="color: #b83838">&#39;mimes:jpg,png&#39;</span><span style="color: #888888">],</span>
        <span style="color: #b83838">&#39;quantity&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;required&#39;</span><span style="color: #888888">,</span> <span style="color: #b83838">&#39;integer&#39;</span><span style="color: #888888">,</span> <span style="color: #b83838">&#39;min:1&#39;</span><span style="color: #888888">],</span>
        <span style="color: #b83838">&#39;description&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;required&#39;</span><span style="color: #888888">],</span>
        <span style="color: #b83838">&#39;short_description&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;nullable&#39;</span><span style="color: #888888">,</span> <span style="color: #b83838">&#39;max:255&#39;</span><span style="color: #888888">],</span>
    <span style="color: #888888">],</span> <span style="color: #b04040">$request</span><span style="color: #666666">-&gt;</span><span style="color: #388038">rules</span><span style="color: #888888">());</span>
<span style="color: #888888">}</span>
</code></pre></div>
<p>Rất đơn giản bạn đã có 100% code coverage cho class <code>ProductCreateRequest</code>!</p>
<p>Về lý thuyết thì không sai, function làm gì thì test đúng chức năng của function đấy. Nhưng tôi thì không thích cách này vì một số lý do:</p>
<ul>
<li>Nó giống như đang duplicate code thành 2 nơi</li>
<li>Tạo thói quen không tốt, người viết chỉ việc copy code là đạt được coverage, mà chẳng cần để ý xem nó có thật sự chạy đúng không</li>
</ul>
<h3 id="the-second-approach">The second approach<a class="headerlink" href="#the-second-approach" title="Permanent link">&para;</a></h3>
<p>Cách tiếp cận thứ hai đó là dựa vào document của Laravel về <a href="https://laravel.com/docs/8.x/validation#manually-creating-validators">Manually Creating Validators</a>.</p>
<p>Chúng ta sẽ tự khởi tạo một <code>Validator</code> instance với các rules được khai báo trong Form Request:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code><span style="color: #2838b0">function</span> <span style="color: #785840">test_it_fails_when_name_is_missing</span><span style="color: #888888">()</span>
<span style="color: #888888">{</span>
    <span style="color: #b04040">$request</span> <span style="color: #666666">=</span> <span style="color: #2838b0">new</span> ProductCreateRequest<span style="color: #888888">();</span>

    <span style="color: #b04040">$validator</span> <span style="color: #666666">=</span> Validator<span style="color: #666666">::</span><span style="color: #388038">make</span><span style="color: #888888">([</span>
        <span style="color: #b83838">&#39;sku&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #b83838">&#39;a-product-sku&#39;</span><span style="color: #888888">,</span>
        <span style="color: #b83838">&#39;quantity&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #444444">1</span><span style="color: #888888">,</span>
        <span style="color: #b83838">&#39;description&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #b83838">&#39;I am the master key, buy me!&#39;</span><span style="color: #888888">,</span>
    <span style="color: #888888">],</span> <span style="color: #b04040">$request</span><span style="color: #666666">-&gt;</span><span style="color: #388038">rules</span><span style="color: #888888">());</span>

    <span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">assertFalse</span><span style="color: #888888">(</span><span style="color: #b04040">$validator</span><span style="color: #666666">-&gt;</span><span style="color: #388038">passes</span><span style="color: #888888">());</span>
    <span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">assertContains</span><span style="color: #888888">(</span><span style="color: #b83838">&#39;title&#39;</span><span style="color: #888888">,</span> <span style="color: #b04040">$validator</span><span style="color: #666666">-&gt;</span><span style="color: #388038">errors</span><span style="color: #888888">()</span><span style="color: #666666">-&gt;</span><span style="color: #388038">keys</span><span style="color: #888888">());</span>
<span style="color: #888888">}</span>
</code></pre></div>
<p>Nếu viết theo test case trên, chúng ta sẽ cần rất nhiều test case nữa để test cho từng rule, của từng input:</p>
<ul>
<li>Test name required</li>
<li>Test name max length</li>
<li>Test sku required</li>
<li>Test sku unique</li>
<li>Test image type</li>
<li>Test quantity required</li>
<li>Test quantity is number</li>
<li>...</li>
</ul>
<p>Nhưng có thể tóm gọn lại bằng cách sử dụng <code>@dataProvider</code>, ví dụ:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code><span style="color: #b85820; font-style: italic">/**</span>
<span style="color: #b85820; font-style: italic"> * @dataProvider provideInvalidData</span>
<span style="color: #b85820; font-style: italic"> */</span>
<span style="color: #2838b0">function</span> <span style="color: #785840">test_invalid_data</span><span style="color: #888888">(</span><span style="color: #2838b0">array</span> <span style="color: #b04040">$data</span><span style="color: #888888">)</span>
<span style="color: #888888">{</span>
    <span style="color: #b04040">$request</span> <span style="color: #666666">=</span> <span style="color: #2838b0">new</span> ProductCreateRequest<span style="color: #888888">();</span>

    <span style="color: #b04040">$validator</span> <span style="color: #666666">=</span> Validator<span style="color: #666666">::</span><span style="color: #388038">make</span><span style="color: #888888">(</span><span style="color: #b04040">$data</span><span style="color: #888888">,</span> <span style="color: #b04040">$request</span><span style="color: #666666">-&gt;</span><span style="color: #388038">rules</span><span style="color: #888888">());</span>

    <span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">assertFalse</span><span style="color: #888888">(</span><span style="color: #b04040">$validator</span><span style="color: #666666">-&gt;</span><span style="color: #388038">passes</span><span style="color: #888888">());</span>
<span style="color: #888888">}</span>

<span style="color: #2838b0">function</span> <span style="color: #785840">makeInvalidData</span><span style="color: #888888">(</span><span style="color: #b04040">$invalidInputs</span><span style="color: #888888">)</span>
<span style="color: #888888">{</span>
    <span style="color: #b04040">$validInputs</span> <span style="color: #666666">=</span> <span style="color: #888888">[</span>
        <span style="color: #b83838">&#39;sku&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #b83838">&#39;a-product-sku&#39;</span><span style="color: #888888">,</span>
        <span style="color: #b83838">&#39;quantity&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #444444">1</span><span style="color: #888888">,</span>
        <span style="color: #b83838">&#39;description&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #b83838">&#39;I am the master key, buy me!&#39;</span><span style="color: #888888">,</span>
    <span style="color: #888888">];</span>

    <span style="color: #2838b0">return</span> <span style="color: #388038">array_merge</span><span style="color: #888888">(</span><span style="color: #b04040">$validInputs</span><span style="color: #888888">,</span> <span style="color: #b04040">$invalidInputs</span><span style="color: #888888">);</span>
<span style="color: #888888">}</span>

<span style="color: #2838b0">function</span> <span style="color: #785840">provideInvalidData</span><span style="color: #888888">()</span>
<span style="color: #888888">{</span>
    <span style="color: #2838b0">return</span> <span style="color: #888888">[</span>
        <span style="color: #888888">[[]],</span> <span style="color: #888888; font-style: italic">// missing fields</span>
        <span style="color: #888888">[</span><span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">makeInvalidData</span><span style="color: #888888">([</span><span style="color: #b83838">&#39;name&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #b83838">&#39;&#39;</span><span style="color: #888888">])],</span>
        <span style="color: #888888">[</span><span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">makeInvalidData</span><span style="color: #888888">([</span><span style="color: #b83838">&#39;name&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #b83838">&#39;name exceed length &#39;</span> <span style="color: #666666">.</span> <span style="color: #388038">str_repeat</span><span style="color: #888888">(</span><span style="color: #b83838">&#39;a&#39;</span><span style="color: #888888">,</span> <span style="color: #444444">256</span><span style="color: #888888">)])],</span>
        <span style="color: #888888; font-style: italic">// How to test file updload?</span>
        <span style="color: #888888">[</span><span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">makeInvalidData</span><span style="color: #888888">([</span><span style="color: #b83838">&#39;sku&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #b83838">&#39;&#39;</span><span style="color: #888888">])],</span>
        <span style="color: #888888">[</span><span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">makeInvalidData</span><span style="color: #888888">([</span><span style="color: #b83838">&#39;sku&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #b83838">&#39;existed-sku&#39;</span><span style="color: #888888">])],</span> <span style="color: #888888; font-style: italic">// How to test Unique rule?</span>
    <span style="color: #888888">];</span>
<span style="color: #888888">}</span>
</code></pre></div>
<p>Vẫn còn một số câu hỏi bỏ ngõ ở trên :D nhưng chủ yếu là đưa ra ý tưởng test trước.</p>
<p>Nhược điểm lớn nhất của cách này đó là không thể test được hai ý <em>(*1)</em> và <em>(*2)</em> nêu ở trên và còn nhiều trường hợp nữa đòi hỏi bạn đào sâu hơn vào cách hoạt động của framework (*3).</p>
<h2 id="integration-test">Integration Test<a class="headerlink" href="#integration-test" title="Permanent link">&para;</a></h2>
<p>Trước khi đi vào chi tiết tôi nghĩ cần thống nhất một chút quan điểm về integration test.</p>
<p>Integration test ở đây tức là test tích hợp một nhóm các Unit với nhau. Laravel gọi chung nó là Feature Test, đã có pull request định tách ra làm 3 loại riêng biệt Unit Test, Integration Test và Feature Test ở <a href="https://github.com/laravel/laravel/pull/5169">đây</a> nhưng cuối cùng vẫn keep như cũ là Unit Test và Feature Test.</p>
<p>Quan điểm ở bài viết này về Integration Test, cụ thể với Laravel đó là:</p>
<ul>
<li>Sử dụng HTTP test để test route (tích hợp controller, form request và framework routing)</li>
<li>Có thể sử dụng DB, ví dụ khi test reposity integrate với DB</li>
<li>Có thể sử dụng <a href="https://laravel.com/docs/8.x/mocking">mock</a> để mock queue, storage, mail, repository, service...</li>
</ul>
<p>Nó vẫn gần gần với Unit Test, chỉ là sử dụng thêm các tính năng, helper của framework để viết test dễ dàng hơn, chưa đến mức test full luồng như một end-user thực sự của hệ thống.</p>
<p><img alt="" src="https://images.viblo.asia/0f20f8f7-40a1-42b4-a2dc-a181bd998c94.png" /></p>
<p>Bắt đầu Integration Test với tài liệu của Laravel: <a href="https://laravel.com/docs/8.x/http-tests">HTTP Tests</a>.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code><span style="color: #2838b0">function</span> <span style="color: #785840">test_it_fails_when_name_is_missing</span><span style="color: #888888">()</span>
<span style="color: #888888">{</span>
    <span style="color: #b04040">$url</span> <span style="color: #666666">=</span> action<span style="color: #888888">([</span>ProductController<span style="color: #666666">::</span><span style="color: #388038">class</span><span style="color: #888888">,</span> <span style="color: #b83838">&#39;store&#39;</span><span style="color: #888888">]);</span>

    <span style="color: #b04040">$response</span> <span style="color: #666666">=</span> <span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">post</span><span style="color: #888888">(</span><span style="color: #b04040">$url</span><span style="color: #888888">,</span> <span style="color: #888888">[</span>
        <span style="color: #b83838">&#39;sku&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #b83838">&#39;a-product-sku&#39;</span><span style="color: #888888">,</span>
        <span style="color: #b83838">&#39;quantity&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #444444">1</span><span style="color: #888888">,</span>
        <span style="color: #b83838">&#39;description&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #b83838">&#39;I am the master key, buy me!&#39;</span><span style="color: #888888">,</span>
    <span style="color: #888888">]);</span>

    <span style="color: #b04040">$response</span><span style="color: #666666">-&gt;</span><span style="color: #388038">assertStatus</span><span style="color: #888888">(</span><span style="color: #444444">422</span><span style="color: #888888">);</span>
    <span style="color: #b04040">$response</span><span style="color: #666666">-&gt;</span><span style="color: #388038">assertSessionHasErrors</span><span style="color: #888888">([</span><span style="color: #b83838">&#39;name&#39;</span><span style="color: #888888">]);</span>
<span style="color: #888888">}</span>
</code></pre></div>
<p>Nó khá giống với Unit Test cách 2 ở trên, nhưng có một số điểm khác biệt dễ nhận thấy đó là:</p>
<ul>
<li>Test trông giống thực tế hơn, vì ta thực hiện request trực tiếp đến route url sử dụng helper method <code>$this-&gt;post()</code> của Laravel. Bạn có thể xem cách Laravel giả lập request ở <a href="https://github.com/laravel/framework/blob/9f986cef11b959679f530eb24d929b39a2690924/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php#L496">đây</a>, bằng cách sử dụng HTTP Kernel, chứ không phải request đến server qua network!</li>
<li>Khắc phục được được vấn đề <em>(*3)</em> vì luồng xử lý request đã follow theo framework</li>
</ul>
<p>Tất nhiên, ta có thể áp dụng <code>@dataProvider</code> như đã giới thiệu ở trên, nhưng liệu có cách nào tốt hơn không? - Sử dụng multiple data provider.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code><span style="color: #2838b0">function</span> <span style="color: #785840">makeInvalidData</span><span style="color: #888888">(</span><span style="color: #b04040">$invalidInputs</span><span style="color: #888888">)</span>
<span style="color: #888888">{</span>
    <span style="color: #b04040">$validInputs</span> <span style="color: #666666">=</span> <span style="color: #888888">[</span>
        <span style="color: #b83838">&#39;sku&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #b83838">&#39;a-product-sku&#39;</span><span style="color: #888888">,</span>
        <span style="color: #b83838">&#39;quantity&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #444444">1</span><span style="color: #888888">,</span>
        <span style="color: #b83838">&#39;description&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #b83838">&#39;I am the master key, buy me!&#39;</span><span style="color: #888888">,</span>
    <span style="color: #888888">];</span>

    <span style="color: #2838b0">return</span> <span style="color: #388038">array_filter</span><span style="color: #888888">(</span><span style="color: #388038">array_merge</span><span style="color: #888888">(</span><span style="color: #b04040">$validInputs</span><span style="color: #888888">,</span> <span style="color: #b04040">$invalidInputs</span><span style="color: #888888">),</span> <span style="color: #2838b0">function</span> <span style="color: #888888">(</span><span style="color: #b04040">$value</span><span style="color: #888888">)</span> <span style="color: #888888">{</span>
        <span style="color: #2838b0">return</span> <span style="color: #b04040">$value</span> <span style="color: #666666">!==</span> <span style="color: #2838b0">null</span><span style="color: #888888">;</span>
    <span style="color: #888888">});</span>
<span style="color: #888888">}</span>

<span style="color: #b85820; font-style: italic">/**</span>
<span style="color: #b85820; font-style: italic"> * @dataProvider provideInvalidName</span>
<span style="color: #b85820; font-style: italic"> * @dataProvider provideInvalidQuantity</span>
<span style="color: #b85820; font-style: italic"> * @dataProvider provideInvalidSku</span>
<span style="color: #b85820; font-style: italic"> * @dataProvider provideInvalidImage</span>
<span style="color: #b85820; font-style: italic"> * ...</span>
<span style="color: #b85820; font-style: italic"> */</span>
<span style="color: #2838b0">function</span> <span style="color: #785840">test_it_show_error_when_input_invalid</span><span style="color: #888888">(</span><span style="color: #b04040">$inputKey</span><span style="color: #888888">,</span> <span style="color: #b04040">$inputValue</span><span style="color: #888888">)</span>
<span style="color: #888888">{</span>
    <span style="color: #b04040">$url</span> <span style="color: #666666">=</span> action<span style="color: #888888">([</span>ProductController<span style="color: #666666">::</span><span style="color: #388038">class</span><span style="color: #888888">,</span> <span style="color: #b83838">&#39;store&#39;</span><span style="color: #888888">]);</span>
    <span style="color: #b04040">$inputs</span> <span style="color: #666666">=</span> <span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">makeInvalidData</span><span style="color: #888888">([</span>
        <span style="color: #b04040">$inputKey</span> <span style="color: #666666">=&gt;</span> <span style="color: #b04040">$inputValue</span><span style="color: #888888">,</span>
    <span style="color: #888888">]);</span>

    <span style="color: #b04040">$response</span> <span style="color: #666666">=</span> <span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">post</span><span style="color: #888888">(</span><span style="color: #b04040">$url</span><span style="color: #888888">,</span> <span style="color: #b04040">$inputs</span><span style="color: #888888">);</span>

    <span style="color: #b04040">$response</span><span style="color: #666666">-&gt;</span><span style="color: #388038">assertSessionHasErrors</span><span style="color: #888888">([</span><span style="color: #b04040">$inputKey</span><span style="color: #888888">]);</span>
<span style="color: #888888">}</span>

<span style="color: #2838b0">function</span> <span style="color: #785840">provideInvalidName</span><span style="color: #888888">()</span>
<span style="color: #888888">{</span>
    <span style="color: #2838b0">return</span> <span style="color: #888888">[</span>
        <span style="color: #888888; font-style: italic">// Tên dataset =&gt; dataset value [$inputKey, $inputValue]</span>
        <span style="color: #b83838">&#39;Name is required&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;name&#39;</span><span style="color: #888888">,</span> <span style="color: #2838b0">null</span><span style="color: #888888">],</span>
        <span style="color: #b83838">&#39;Name is limit to 255 chars&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;name&#39;</span><span style="color: #888888">,</span> <span style="color: #388038">str_repeat</span><span style="color: #888888">(</span><span style="color: #b83838">&#39;a&#39;</span><span style="color: #888888">,</span> <span style="color: #444444">256</span><span style="color: #888888">)],</span>
    <span style="color: #888888">];</span>
<span style="color: #888888">}</span>

<span style="color: #2838b0">function</span> <span style="color: #785840">provideInvalidQuantity</span><span style="color: #888888">()</span>
<span style="color: #888888">{</span>
    <span style="color: #2838b0">return</span> <span style="color: #888888">[</span>
        <span style="color: #b83838">&#39;Quantity is required&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;quantity&#39;</span><span style="color: #888888">,</span> <span style="color: #2838b0">null</span><span style="color: #888888">],</span>
        <span style="color: #b83838">&#39;Quantity should be integer&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;quantity&#39;</span><span style="color: #888888">,</span> <span style="color: #444444">1.1</span><span style="color: #888888">],</span>
        <span style="color: #b83838">&#39;Quantity should be greater than 1&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;quantity&#39;</span><span style="color: #888888">,</span> <span style="color: #444444">0</span><span style="color: #888888">],</span>
    <span style="color: #888888">];</span>
<span style="color: #888888">}</span>
</code></pre></div>
<p>PHPUnit hỗ trợ nhiều data provider cho một test case, nên ý tưởng ở đây là: mỗi input sẽ có một data provider và trong provider chúng ta sẽ mô tả dữ liệu cho case làm validation failed. Với cách này, chúng ta focus vào việc tạo dữ liệu test. Và với việc đặt tên cho mỗi dataset, khi đọc lại code sẽ rất dễ hiểu, cũng như khi một trường hợp fail, PHPUnit sẽ hiển thị message rõ ràng:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code>1) Tests\Feature\ProductControllerTest::test_it_show_error_when_input_invalid with dataset &quot;Quantity should be integer&quot; (&#39;quantity&#39;, 1.1)
</code></pre></div>
<p>Nếu bạn follow theo convention: Controller chỉ xử lý điều hướng request, logic được xử lý ở Repository hay Service class. Thì việc test unit thuần cho controller là không cần thiết, thay vào đó chúng ta sẽ thực hiện test integration: routing, controller, form request. Việc assert cũng dễ dàng hơn do Laravel đã hỗ trợ sẵn nhiều method <a href="https://laravel.com/docs/8.x/http-tests#available-assertions">asserts cho HTTP Test</a>.</p>
<p>Ở phần trên, chúng ta mới chỉ ví dụ về các input đơn giản, còn 2 vấn đề chưa được nhắc tới đó là test database rule unique và image upload.</p>
<h3 id="database-rule">Database rule<a class="headerlink" href="#database-rule" title="Permanent link">&para;</a></h3>
<p>Cách đơn giản nhất theo hướng tiếp cận Integration Test đó là sử dụng database test để tạo dữ liệu mẫu theo test case.</p>
<p>Ví dụ ở <code>ProductCreateRequest</code> chúng ta có khai báo rule unique cho <code>sku</code>, vậy thì cách đơn giản nhất là chuẩn bị database test với 1 bản khi có <code>sku = existed-sku</code>, sau đó trong test case bạn sẽ truyền input cho sku là <code>existed-sku</code>.</p>
<p>Thông thường factory sẽ được sử dụng để tạo data test cho model.</p>
<p>Vì factory không sử dụng được bên trong data provider của phpunit, nên chúng ta cần thay đổi chút về method test:
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code><span style="color: #b85820; font-style: italic">/**</span>
<span style="color: #b85820; font-style: italic"> * ...</span>
<span style="color: #b85820; font-style: italic"> * @dataProvider provideInvalidSku</span>
<span style="color: #b85820; font-style: italic"> * ...</span>
<span style="color: #b85820; font-style: italic"> */</span>
<span style="color: #2838b0">function</span> <span style="color: #785840">test_it_show_error_when_input_invalid</span><span style="color: #888888">(</span><span style="color: #b04040">$inputKey</span><span style="color: #888888">,</span> <span style="color: #b04040">$inputValue</span><span style="color: #888888">)</span>
<span style="color: #888888">{</span>
    <span style="color: #b04040">$url</span> <span style="color: #666666">=</span> action<span style="color: #888888">([</span>ProductController<span style="color: #666666">::</span><span style="color: #388038">class</span><span style="color: #888888">,</span> <span style="color: #b83838">&#39;store&#39;</span><span style="color: #888888">]);</span>
    <span style="color: #b04040">$inputs</span> <span style="color: #666666">=</span> <span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">makeInvalidData</span><span style="color: #888888">([</span>
        <span style="color: #b04040">$inputKey</span> <span style="color: #666666">=&gt;</span> <span style="color: #388038">is_callable</span><span style="color: #888888">(</span><span style="color: #b04040">$inputValue</span><span style="color: #888888">)</span> <span style="color: #666666">?</span> <span style="color: #b04040">$inputValue</span><span style="color: #888888">()</span> <span style="color: #666666">:</span> <span style="color: #b04040">$inputValue</span><span style="color: #888888">,</span>
    <span style="color: #888888">]);</span>

    <span style="color: #b04040">$response</span> <span style="color: #666666">=</span> <span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">post</span><span style="color: #888888">(</span><span style="color: #b04040">$url</span><span style="color: #888888">,</span> <span style="color: #b04040">$inputs</span><span style="color: #888888">);</span>

    <span style="color: #b04040">$response</span><span style="color: #666666">-&gt;</span><span style="color: #388038">assertSessionHasErrors</span><span style="color: #888888">([</span><span style="color: #b04040">$inputKey</span><span style="color: #888888">]);</span>
<span style="color: #888888">}</span>

<span style="color: #2838b0">function</span> <span style="color: #785840">provideInvalidSku</span><span style="color: #888888">()</span>
<span style="color: #888888">{</span>
    <span style="color: #2838b0">return</span> <span style="color: #888888">[</span>
        <span style="color: #888888; font-style: italic">// Tên dataset =&gt; dataset value [$inputKey, $inputValue]</span>
        <span style="color: #b83838">&#39;SKU is required&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span><span style="color: #b83838">&#39;sku&#39;</span><span style="color: #888888">,</span> <span style="color: #2838b0">null</span><span style="color: #888888">],</span>
        <span style="color: #b83838">&#39;SKU must be unique&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span>
            <span style="color: #b83838">&#39;sku&#39;</span><span style="color: #888888">,</span>
            <span style="color: #2838b0">function</span> <span style="color: #888888">()</span> <span style="color: #888888">{</span>
                Product<span style="color: #666666">::</span><span style="color: #388038">factory</span><span style="color: #888888">()</span><span style="color: #666666">-&gt;</span><span style="color: #388038">create</span><span style="color: #888888">([</span><span style="color: #b83838">&#39;sku&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #b83838">&#39;existed-sku&#39;</span><span style="color: #888888">]);</span>

                <span style="color: #2838b0">return</span> <span style="color: #b83838">&#39;existed-sku&#39;</span><span style="color: #888888">;</span>
            <span style="color: #888888">},</span>
        <span style="color: #888888">],</span>
    <span style="color: #888888">];</span>
<span style="color: #888888">}</span>
</code></pre></div></p>
<h3 id="file-upload">File upload<a class="headerlink" href="#file-upload" title="Permanent link">&para;</a></h3>
<p>Laravel hỗ trợ tạo fake upload file, chúng ta có thể áp dụng nó như sau:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code><span style="color: #2838b0">function</span> <span style="color: #785840">provideInvalidImage</span><span style="color: #888888">()</span>
<span style="color: #888888">{</span>
    <span style="color: #2838b0">return</span> <span style="color: #888888">[</span>
        <span style="color: #888888; font-style: italic">// Tên dataset =&gt; dataset value [$inputKey, $inputValue]</span>
        <span style="color: #b83838">&#39;Image must be jpg or png&#39;</span> <span style="color: #666666">=&gt;</span> <span style="color: #888888">[</span>
            <span style="color: #b83838">&#39;image&#39;</span><span style="color: #888888">,</span>
            <span style="color: #2838b0">function</span> <span style="color: #888888">()</span> <span style="color: #888888">{</span>
                Storage<span style="color: #666666">::</span><span style="color: #388038">fake</span><span style="color: #888888">();</span>

                <span style="color: #2838b0">return</span> UploadedFile<span style="color: #666666">::</span><span style="color: #388038">fake</span><span style="color: #888888">()</span><span style="color: #666666">-&gt;</span><span style="color: #388038">image</span><span style="color: #888888">(</span><span style="color: #b83838">&#39;product.gif&#39;</span><span style="color: #888888">);</span>
            <span style="color: #888888">},</span>
        <span style="color: #888888">],</span>
    <span style="color: #888888">];</span>
<span style="color: #888888">}</span>
</code></pre></div>
<p>Rất đơn giản phải không. Tương tự chúng ta sẽ có thêm các case validation success.</p>
<h2 id="kết-luận">Kết luận<a class="headerlink" href="#kết-luận" title="Permanent link">&para;</a></h2>
<p>Như các bạn thấy, có nhiều cách để test form validation trong laravel, vì vậy việc làm theo hướng nào phụ thuộc vào chính bạn hay dự án quyết định, bài viết chỉ nêu ra một số cách để bạn tham khảo.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../02-mocking/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Mocking
            </div>
          </div>
        </a>
      
      
        <a href="../04-model/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Model
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["header.autohide", "navigation.instant"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.fb4a9340.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.a1c7c35e.min.js"></script>
      
    
  </body>
</html>